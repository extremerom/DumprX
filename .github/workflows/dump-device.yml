name: Create Device Dump

on:
  workflow_dispatch:
    inputs:
      dump_url:
        description: 'URL del dump del firmware (debe estar entre comillas simples si contiene caracteres especiales)'
        required: true
        type: string
      org_name:
        default: 'extremerom'
        description: 'Nombre del autor o organizacion de destino (ej: usuario)'
        required: true
        type: string

jobs:
  dump:
    runs-on: Unica
    environment:
      name: /dev/null
      url: /dev/null
    
    permissions:
      contents: write
      actions: write
      id-token: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unace unrar zip unzip p7zip-full p7zip-rar sharutils rar uudeview mpack arj cabextract device-tree-compiler liblzma-dev python3-pip brotli liblz4-tool axel gawk aria2 detox cpio rename liblz4-dev jq git-lfs
          chmod +x setup.sh
          ./setup.sh 
          
      - name: Install uv for Python packages
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Setup GitHub token
        run: |
          echo "${GITHUB_TOKEN}" > .github_token
        env:
          GITHUB_TOKEN: ${{ secrets.TEST }}
      
      - name: Setup GitHub organization name
        run: |
          echo "${{ inputs.org_name }}" > .github_orgname
      
      - name: Run dumper script
        run: |
          export HOME=${GITHUB_WORKSPACE}
          cd ${GITHUB_WORKSPACE}
          chmod +x dumper.sh
          ./dumper.sh "${DUMP_URL}"
          sudo chown -R $(whoami):$(id -gn) ./out
          sudo chmod -R 777 ./out
          cd out
          zip -r -9 ../out.zip .

        env:
          DUMP_URL: ${{ inputs.dump_url }}
          GITHUB_TOKEN: ${{ secrets.TEST }}
        continue-on-error: true

      - name: Set variables
        run: |
          echo "date=$(TZ=Asia/Ho_Chi_Minh date +%Y-%m-%d-%H:%M:%S)" >> $GITHUB_OUTPUT
          echo "Outdir=${GITHUB_WORKSPACE}" >> $GITHUB_OUTPUT
        id: var
      
      - name: Upload dump artifacts (if not pushed to GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: device-dump
          path: out.zip
          retention-days: 7
        continue-on-error: true
          
      - name: Publish to github
        uses: softprops/action-gh-release@v1
        with:
          files: | 
            ${{ steps.var.outputs.Outdir }}/out.zip
          name: Dump Release
          tag_name: ${{ github.run_id }}
          body: |
            - ${{ steps.var.outputs.date }}
        env:
          GITHUB_TOKEN: ${{ secrets.TEST }}
